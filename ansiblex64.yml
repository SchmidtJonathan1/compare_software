###### WIP (install software)  ######

## Install windows software with ansible x64
# ./roles/test/vars/vars.yml
---
apps:
  - softwareName: KeePass
    softwareVersion: "2.49"
    softwareParam: /VERYSILENT
    installPath: C:\tmp\KeePass-2.49-Setup.exe
  - softwareName: MobaXterm
    softwareVersion: "21.4.0.4736"
    softwareParam: /qn
    installPath: 
  - softwareName: draw.io
    softwareVersion: "15.2.7"
    softwareParam: /SILENT
    installPath: 

# ./roles/test/tasks/base.yml
---
## Include vars from role path
- name: includ vars
  include_vars: vars.yml

## Get all PSChildName names from registry
- name: reg displayname x64
  ansible.windows.win_shell: (Get-ItemProperty -Path HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*).PSChildName
  register: checkChildNamex64

## Loop registry with pschildnames
- name: reg displayversion x64
  ansible.windows.win_reg_stat: 
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\{{ item }}
  loop: "{{ checkChildNamex64.stdout_lines }}"
  register: checkVerx64

## Set facts for name and version
- name: msg x64 DisplayName and Version
  set_fact:
    regListx64: "{{ regListx64| default ([]) + [item.properties.DisplayName.value + ' ' + item.properties.DisplayVersion.value] }}"
  when: item.properties.DisplayName.value is defined
  loop: "{{ checkVerx64.results }} "

- name: copy file
  ansible.windows.win_copy:
    src: software
    dest: C:\tmp\

## Install software
- name: Install software x64
  debug:
    msg: "Work Twerk x64"
#  ansible.windows.win_package:
#    path: "{{ item.installPath }}" 
#    arguments: "{{ item.softwareParam }}"
#    state: present
  when:
    - regListx64 | regex_search(item.softwareName)
    - not regListx64 | regex_search(item.softwareVersion)
  loop: "{{ apps }}"
...
